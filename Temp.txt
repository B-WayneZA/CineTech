<?php
// Start session to store user login status
header("Access-Control-Allow-Origin: *");session_start();

// Set current page variable for header navigation
$currentPage = 'register';

if (isset($_SESSION['user_id'])) {
    header('Location:https://wheatley.cs.up.ac.za/u23535246/COS216/PA4/php/index.php'); // Replace 'index.php' with the path to your home page
    exit();
}

// Check if the login form is submitted
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Get username and password from the login form
    $name = $_POST['name'];
    $surname = $_POST['surname'];
    $username = $_POST['username'];
    $email = $_POST['email'];
    $password = $_POST['password'];
    $phoneNum = $_POST['phone'];

    // Validate the email and password (You can add more validation as needed)
    if (empty($email) || empty($password)) {
        $error = "Email and password are required";
    } else {
        // Prepare the data for JSON request
        $data = array(
            'type' => 'Register',
            'name' => $name,
            'username' => $username,
            'surname' => $surname,
            'email' => $email,
            'password' => $password,
            'phoneNum' => $phoneNum
        );

        // Convert data to JSON format
        $json_data = json_encode($data);

        // Create a new cURL resource
        $ch = curl_init();

        // Set the URL
        curl_setopt($ch, CURLOPT_URL, 'https://wheatley.cs.up.ac.za/u23535246/api.php');

        // Set the request method to POST
        curl_setopt($ch, CURLOPT_POST, 1);

        // Set the request data as JSON
        curl_setopt($ch, CURLOPT_POSTFIELDS, $json_data);

        // Set the Content-Type header
        curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json'));

        // Set basic authentication credentials
        curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_BASIC);
        curl_setopt($ch, CURLOPT_USERPWD, 'u23535246:Toponepercent120'); 
        // Return response instead of outputting it
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        // Execute the request
        $response = curl_exec($ch);

        // Close cURL resource
        curl_close($ch);

        // Decode the JSON response
        $login_response = json_decode($response, true);
        // Check if the login was successful

        if (isset($login_response) && $login_response['status'] === 'success') {
            // Decode the JSON string inside the 'data' field
            $responseData = $login_response['data'];
            // Check if decoding was successful
            
                // Set session variables and redirect to home page
                $_SESSION['api_key'] = $login_response['data']['apiKey'];
                $_SESSION['username'] = $email;
                echo '<p class="success">Registration successful! Your API key is: ' .$login_response['data']['apiKey'] . '</p>';
                header('Location:https://wheatley.cs.up.ac.za/u23535246/COS216/PA4/php/index.php'); // Replace 'index.php' with the path to your home page
                    exit();
            
        } else {
            $error = $responseData['data']; // Display the error message returned by the API        
        }
    }
}




?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration</title>
    <link rel="stylesheet" href="/PA4/css/register.css">
    <script src="https://kit.fontawesome.com/6906c5e38f.js" crossorigin="anonymous"></script>
</head>

<?php
// Check the current theme preference from the cookie
$theme = isset($_COOKIE['theme']) ? $_COOKIE['theme'] : 'light';
?>

<body class="<?php echo $theme; ?>">   <!-- Loading overlay -->

<?php include("header.php"); ?>

<div class="container">
    <h2>Register</h2>
    <?php if (isset($error)): ?>
        <p class="error"><?php echo $error; ?></p>
    <?php endif; ?>
    <form id="registerForm" action="" method="post">
        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="surname">Surname</label>
            <input type="text" id="surname" name="surname" required>
        </div>
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required>
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required>
        </div>
        <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="text" id="phone" name="phone" required>
        </div>
        <div class="form-group">
            <button type="submit">Register</button>
        </div>
    </form>
</div>

<?php include('/PA4/php/footer.php'); ?> 


</body>

</html>